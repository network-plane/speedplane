<!doctype html>
<html lang="en" data-template="{{.CurrentTemplate}}" data-scheme="{{.CurrentScheme}}">
<head>
  <meta charset="utf-8" />
  <title>{{.Title}}</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" integrity="sha512-DTOQO9RWCH3ppGqcWaEA1BIZOC6xxalwEsw9c2QQeAIftl+Vegovlnee1c9QX4TctnWMn13TZye+giMm8e2LwA==" crossorigin="anonymous" referrerpolicy="no-referrer" />
  <style id="theme-css">
    /* Theme CSS loaded dynamically from /api/theme */
  </style>
</head>
<body>
<script>
// Theme management - fetch CSS based on localStorage
(function() {
  const savedTemplate = localStorage.getItem('template') || '{{.CurrentTemplate}}' || 'speedplane';
  const savedScheme = localStorage.getItem('scheme') || '{{.CurrentScheme}}' || 'default';

  document.documentElement.setAttribute('data-template', savedTemplate);
  document.documentElement.setAttribute('data-scheme', savedScheme);

  // Fetch theme CSS from API with timeout
  var themeController = new AbortController();
  var themeTimeout = setTimeout(function() { themeController.abort(); }, 2000);
  fetch('/api/theme?template=' + encodeURIComponent(savedTemplate) + '&scheme=' + encodeURIComponent(savedScheme), {
    signal: themeController.signal
  })
    .then(function(res) {
      clearTimeout(themeTimeout);
      return res.text();
    })
    .then(function(css) {
      var style = document.getElementById('theme-css');
      if (style) style.textContent = css;
    })
    .catch(function(err) {
      clearTimeout(themeTimeout);
      if (err.name !== 'AbortError') {
        console.error('Failed to load theme:', err);
      }
    });

  window.addEventListener('DOMContentLoaded', function() {
    // Hidden scheme menu for preferences modal to read from
    var hiddenMenus = document.createElement('div');
    hiddenMenus.style.display = 'none';
    hiddenMenus.innerHTML = '<div id="schemeMenu">{{.SchemeMenuHTML}}</div>';
    document.body.appendChild(hiddenMenus);
  });
})();
  </script>
  <div class="header">
    <div class="brand">
      <div class="dot"></div>
      <div>
        <div class="h-title">Speedtest Tracker</div>
        <div class="h-sub" id="subtitle">Dashboard</div>
      </div>
    </div>
    <div class="search">
      <button id="run-now-btn" class="btn">Run speedtest now</button>
    </div>
  </div>

  <aside class="sidebar collapsed" id="sidebar">
    <div class="sidebar-header">
      <div class="app-title">Speedtest Tracker</div>
    </div>
    <nav class="sidebar-nav">
      <button class="nav-item nav-item-active" data-view="dashboard" data-letter="D"><span>Dashboard</span></button>
      <button class="nav-item" data-view="history" data-letter="R"><span>Results</span></button>
      <button class="nav-item" data-view="preferences" data-letter="P"><span>Preferences</span></button>
    </nav>
    <div class="sidebar-section">
      <div class="sidebar-section-title">Links</div>
      <a class="nav-link" href="https://github.com" target="_blank" rel="noreferrer">GitHub</a>
    </div>
    <button class="sidebar-toggle" id="sidebar-toggle" title="Toggle sidebar">
      <i class="fas fa-chevron-left"></i>
      <span>Collapse</span>
    </button>
  </aside>

  <div class="main">

      <section id="view-dashboard" class="view view-active">
        <div class="cards-row">
          <div class="card">
            <div class="card-label">Latest download</div>
            <div id="latest-download-value" class="card-value">–</div>
            <div id="latest-download-sub" class="card-sub">Mbps</div>
          </div>
          <div class="card">
            <div class="card-label">Latest upload</div>
            <div id="latest-upload-value" class="card-value">–</div>
            <div id="latest-upload-sub" class="card-sub">Mbps</div>
          </div>
          <div class="card">
            <div class="card-label">Latest ping</div>
            <div id="latest-ping-value" class="card-value">–</div>
            <div id="latest-ping-sub" class="card-sub">ms</div>
          </div>
          <div class="card">
            <div class="card-label">Latest jitter</div>
            <div id="latest-jitter-value" class="card-value">–</div>
            <div id="latest-jitter-sub" class="card-sub">ms</div>
          </div>
          <div class="card">
            <div class="card-label">Latest packet loss</div>
            <div id="latest-packetloss-value" class="card-value">–</div>
            <div id="latest-packetloss-sub" class="card-sub">%</div>
          </div>
        </div>

        <div class="panel">
          <div class="panel-header">
            <div class="panel-title">Download (Mbps)</div>
            <select id="range-download" class="select">
              <option value="24h">Last 24h</option>
              <option value="7d">Last 7 days</option>
              <option value="30d">Last 30 days</option>
            </select>
          </div>
          <div class="chart" id="download-chart"></div>
        </div>

        <div class="panel">
          <div class="panel-header">
            <div class="panel-title">Upload (Mbps)</div>
            <select id="range-upload" class="select">
              <option value="24h">Last 24h</option>
              <option value="7d">Last 7 days</option>
              <option value="30d">Last 30 days</option>
            </select>
          </div>
          <div class="chart" id="upload-chart"></div>
        </div>

        <div class="panel">
          <div class="panel-header">
            <div class="panel-title">Latency (ms)</div>
            <select id="range-latency" class="select">
              <option value="24h">Last 24h</option>
              <option value="7d">Last 7 days</option>
              <option value="30d">Last 30 days</option>
            </select>
          </div>
          <div class="chart" id="latency-chart"></div>
        </div>

        <div class="panel">
          <div class="panel-header">
            <div class="panel-title">Jitter (ms)</div>
            <select id="range-jitter" class="select">
              <option value="24h">Last 24h</option>
              <option value="7d">Last 7 days</option>
              <option value="30d">Last 30 days</option>
            </select>
          </div>
          <div class="chart" id="jitter-chart"></div>
        </div>
      </section>

      <section id="view-history" class="view">
        <div class="panel">
          <div class="panel-header">
            <div class="panel-title">Results</div>
          </div>
          <table class="table" id="history-table">
            <thead>
              <tr>
                <th>ID</th>
                <th>Date/time</th>
                <th>Download (Mbps)</th>
                <th>Upload (Mbps)</th>
                <th>Ping (ms)</th>
                <th>Jitter (ms)</th>
                <th>Packet Loss (%)</th>
                <th>IP Address</th>
                <th>ISP</th>
                <th>Server</th>
              </tr>
            </thead>
            <tbody>
            </tbody>
          </table>
        </div>
      </section>

      <section id="view-preferences" class="view">
        <div class="panel">
          <div class="panel-header">
            <div class="panel-title">Appearance</div>
          </div>
          <div class="form">
            <div class="form-row">
              <label>Theme</label>
              <select id="pref-template">
                {{range .TemplatesList}}<option value="{{.}}">{{.}}</option>{{end}}
              </select>
            </div>
            <div class="form-row">
              <label>Color Scheme</label>
              <select id="pref-scheme"></select>
            </div>
          </div>
        </div>

        <div class="panel">
          <div class="panel-header">
            <div class="panel-title">Schedules</div>
          </div>
          <div id="schedules-list"></div>

          <form id="schedule-form" class="form">
            <input type="hidden" id="schedule-form-id" name="id" />
            <div class="form-row">
              <label>Name</label>
              <input type="text" id="schedule-form-name" name="name" />
            </div>
            <div class="form-row">
              <label>Type</label>
              <select id="schedule-form-type" name="type">
                <option value="interval">Interval</option>
                <option value="daily">Daily</option>
              </select>
            </div>
            <div class="form-row">
              <label>Every (for interval)</label>
              <input type="text" id="schedule-form-every" name="every" placeholder="1h, 30m, 6h" />
            </div>
            <div class="form-row">
              <label>Time of day (for daily)</label>
              <input type="text" id="schedule-form-timeOfDay" name="timeOfDay" placeholder="14:30" />
            </div>
            <div class="form-row">
              <label>Enabled</label>
              <input type="checkbox" id="schedule-form-enabled" name="enabled" checked />
            </div>
            <button type="submit" class="btn" id="schedule-form-submit">Add schedule</button>
            <button type="button" class="btn" id="schedule-form-cancel" style="display: none;">Cancel</button>
          </form>
        </div>
      </section>
    </div>

  <script type="module" src="main.js"></script>
</body>
</html>
