<!doctype html>
<html lang="en" data-template="{{.CurrentTemplate}}" data-scheme="{{.CurrentScheme}}">
<head>
  <meta charset="utf-8" />
  <title>{{.Title}}</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" integrity="sha512-DTOQO9RWCH3ppGqcWaEA1BIZOC6xxalwEsw9c2QQeAIftl+Vegovlnee1c9QX4TctnWMn13TZye+giMm8e2LwA==" crossorigin="anonymous" referrerpolicy="no-referrer" />
  <style id="theme-css">
    /* Theme CSS loaded dynamically from /api/theme */
  </style>
  <style>
    /* Speedplane-specific styles */
    .about-section{
      text-align:center;
      padding:20px;
    }
    .about-logo{
      color:var(--accent);
      margin-bottom:16px;
    }
    .about-section h3{
      font-size:18px;
      color:var(--txt);
      margin-bottom:4px;
      text-transform:none;
      letter-spacing:0;
    }
    .about-version{
      color:var(--muted);
      font-size:12px;
      margin-bottom:16px;
    }
    .about-desc{
      color:var(--txt);
      font-size:13px;
      line-height:1.6;
      margin-bottom:20px;
    }
    .about-links{
      margin-bottom:20px;
    }
    .about-links a{
      color:var(--accent);
      text-decoration:none;
      font-size:13px;
      display:inline-flex;
      align-items:center;
      gap:6px;
    }
    .about-links a:hover{
      text-decoration:underline;
    }
    .about-copyright{
      color:var(--muted);
      font-size:11px;
    }
    .header .search{
      margin-left:auto;
      justify-content:flex-end;
    }
    .progress-modal-overlay{
      position:fixed;
      top:0;
      left:0;
      right:0;
      bottom:0;
      background:rgba(0,0,0,.7);
      display:flex;
      align-items:center;
      justify-content:center;
      z-index:1000;
    }
    .progress-modal{
      background:var(--panel);
      border:1px solid var(--border);
      border-radius:8px;
      padding:24px;
      min-width:300px;
      max-width:500px;
    }
    .progress-header{
      margin-bottom:16px;
    }
    .progress-header h3{
      margin:0;
      font-size:18px;
      color:var(--txt);
    }
    .progress-content{
      display:flex;
      flex-direction:column;
      align-items:center;
      gap:12px;
    }
    .progress-spinner{
      width:40px;
      height:40px;
      border:3px solid var(--border);
      border-top-color:var(--accent);
      border-radius:50%;
      animation:spin 1s linear infinite;
    }
    @keyframes spin{
      to{transform:rotate(360deg);}
    }
    .progress-status{
      font-size:14px;
      font-weight:600;
      color:var(--accent);
      text-transform:uppercase;
      letter-spacing:0.1em;
    }
    .progress-message{
      font-size:13px;
      color:var(--muted);
      text-align:center;
    }
    .chart-toggle{
      position:relative;
      width:44px;
      height:22px;
      background:var(--border);
      border:1px solid var(--border);
      border-radius:11px;
      cursor:pointer;
      padding:0;
      transition:background .2s, border-color .2s;
      display:flex;
      align-items:center;
      box-sizing:border-box;
    }
    .chart-toggle:hover{
      background:rgba(255,255,255,.08);
      border-color:var(--accent);
    }
    .chart-toggle.active{
      background:var(--accent);
      border-color:var(--accent);
    }
    .chart-toggle-slider{
      position:absolute;
      left:2px;
      width:18px;
      height:18px;
      background:var(--bg);
      border-radius:50%;
      transition:transform .2s ease;
      box-shadow:0 1px 3px rgba(0,0,0,.3);
    }
    .chart-toggle.active .chart-toggle-slider{
      transform:translateX(22px);
    }
  </style>
</head>
<body>
<script>
// Theme management - fetch CSS based on localStorage
(function() {
  const savedTemplate = localStorage.getItem('template') || '{{.CurrentTemplate}}' || 'speedplane';
  const savedScheme = localStorage.getItem('scheme') || '{{.CurrentScheme}}' || 'default';

  document.documentElement.setAttribute('data-template', savedTemplate);
  document.documentElement.setAttribute('data-scheme', savedScheme);

  // Fetch theme CSS from API with timeout
  var themeController = new AbortController();
  var themeTimeout = setTimeout(function() { themeController.abort(); }, 2000);
  fetch('/api/theme?template=' + encodeURIComponent(savedTemplate) + '&scheme=' + encodeURIComponent(savedScheme), {
    signal: themeController.signal
  })
    .then(function(res) {
      clearTimeout(themeTimeout);
      return res.text();
    })
    .then(function(css) {
      var style = document.getElementById('theme-css');
      if (style) style.textContent = css;
    })
    .catch(function(err) {
      clearTimeout(themeTimeout);
      if (err.name !== 'AbortError') {
        console.error('Failed to load theme:', err);
      }
    });

  window.addEventListener('DOMContentLoaded', function() {
    // Hidden scheme menu for preferences modal to read from
    var hiddenMenus = document.createElement('div');
    hiddenMenus.style.display = 'none';
    hiddenMenus.innerHTML = '<div id="schemeMenu">{{.SchemeMenuHTML}}</div>';
    document.body.appendChild(hiddenMenus);
  });
})();
  </script>
  <div class="header">
    <div class="brand">
      <div class="dot"></div>
      <div>
        <div class="h-title">speedplane</div>
        <div class="h-sub" id="subtitle">Dashboard</div>
      </div>
    </div>
    <div class="search">
      <div class="timer-circle" id="schedule-timer" title="Loading..." style="display: none;"></div>
      <button id="run-now-btn" class="btn">Run speedtest now</button>
    </div>
  </div>

  <aside class="sidebar collapsed" id="sidebar">
    <div class="sidebar-header">
      <div class="app-title">speedplane</div>
    </div>
    <nav class="sidebar-nav">
      <button class="nav-item nav-item-active" data-view="dashboard" data-letter="D"><span>Dashboard</span></button>
      <button class="nav-item" data-view="history" data-letter="R"><span>Results</span></button>
      <button class="nav-item" data-view="preferences" data-letter="P"><span>Preferences</span></button>
      <button class="nav-item" data-view="about" data-letter="A"><span>About</span></button>
    </nav>
    <button class="sidebar-toggle" id="sidebar-toggle" title="Toggle sidebar">
      <i class="fas fa-chevron-left"></i>
      <span>Collapse</span>
    </button>
  </aside>

  <div class="main">

      <section id="view-dashboard" class="view view-active">
        <div class="cards-row">
          <div class="card">
            <div class="card-label">Latest download</div>
            <div id="latest-download-value" class="card-value">–</div>
            <div id="latest-download-sub" class="card-sub">Mbps</div>
            <div id="latest-download-compare" class="card-compare"></div>
          </div>
          <div class="card">
            <div class="card-label">Latest upload</div>
            <div id="latest-upload-value" class="card-value">–</div>
            <div id="latest-upload-sub" class="card-sub">Mbps</div>
            <div id="latest-upload-compare" class="card-compare"></div>
          </div>
          <div class="card">
            <div class="card-label">Latest ping</div>
            <div id="latest-ping-value" class="card-value">–</div>
            <div id="latest-ping-sub" class="card-sub">ms</div>
            <div id="latest-ping-compare" class="card-compare"></div>
          </div>
          <div class="card">
            <div class="card-label">Latest jitter</div>
            <div id="latest-jitter-value" class="card-value">–</div>
            <div id="latest-jitter-sub" class="card-sub">ms</div>
            <div id="latest-jitter-compare" class="card-compare"></div>
          </div>
          <div class="card">
            <div class="card-label">Latest packet loss</div>
            <div id="latest-packetloss-value" class="card-value">–</div>
            <div id="latest-packetloss-sub" class="card-sub">%</div>
            <div id="latest-packetloss-compare" class="card-compare"></div>
          </div>
        </div>

        <div class="panel">
          <div class="panel-header">
            <div class="panel-title">Download (Mbps)</div>
            <div style="display: flex; gap: 12px; align-items: center;">
              <select id="range-download" class="select">
                <option value="24h">Last 24h</option>
                <option value="7d">Last 7 days</option>
                <option value="30d">Last 30 days</option>
              </select>
              <div style="display: flex; align-items: center; gap: 6px;">
                <span style="font-size: 11px; color: var(--muted);">Percentile</span>
                <button type="button" class="chart-toggle" id="chart-type-download">
                  <span class="chart-toggle-slider"></span>
                </button>
              </div>
            </div>
          </div>
          <div class="chart" id="download-chart"></div>
        </div>

        <div class="panel">
          <div class="panel-header">
            <div class="panel-title">Upload (Mbps)</div>
            <div style="display: flex; gap: 12px; align-items: center;">
              <select id="range-upload" class="select">
                <option value="24h">Last 24h</option>
                <option value="7d">Last 7 days</option>
                <option value="30d">Last 30 days</option>
              </select>
              <div style="display: flex; align-items: center; gap: 6px;">
                <span style="font-size: 11px; color: var(--muted);">Percentile</span>
                <button type="button" class="chart-toggle" id="chart-type-upload">
                  <span class="chart-toggle-slider"></span>
                </button>
              </div>
            </div>
          </div>
          <div class="chart" id="upload-chart"></div>
        </div>

        <div class="panel">
          <div class="panel-header">
            <div class="panel-title">Latency (ms)</div>
            <div style="display: flex; gap: 12px; align-items: center;">
              <select id="range-latency" class="select">
                <option value="24h">Last 24h</option>
                <option value="7d">Last 7 days</option>
                <option value="30d">Last 30 days</option>
              </select>
              <div style="display: flex; align-items: center; gap: 6px;">
                <span style="font-size: 11px; color: var(--muted);">Percentile</span>
                <button type="button" class="chart-toggle" id="chart-type-latency">
                  <span class="chart-toggle-slider"></span>
                </button>
              </div>
            </div>
          </div>
          <div class="chart" id="latency-chart"></div>
        </div>

        <div class="panel">
          <div class="panel-header">
            <div class="panel-title">Jitter (ms)</div>
            <div style="display: flex; gap: 12px; align-items: center;">
              <select id="range-jitter" class="select">
                <option value="24h">Last 24h</option>
                <option value="7d">Last 7 days</option>
                <option value="30d">Last 30 days</option>
              </select>
              <div style="display: flex; align-items: center; gap: 6px;">
                <span style="font-size: 11px; color: var(--muted);">Percentile</span>
                <button type="button" class="chart-toggle" id="chart-type-jitter">
                  <span class="chart-toggle-slider"></span>
                </button>
              </div>
            </div>
          </div>
          <div class="chart" id="jitter-chart"></div>
        </div>

        <div style="display: flex; gap: 8px; justify-content: center; margin-top: 16px;">
          <a href="/api/export/current.json" class="btn" download>Export JSON</a>
          <a href="/api/export/current.csv" class="btn" download>Export CSV</a>
        </div>
      </section>

      <section id="view-history" class="view">
        <div class="panel">
          <div class="panel-header">
            <div class="panel-title">Results</div>
            <div style="display: flex; gap: 8px;">
              <a href="/api/export/history.json" class="btn" download>Export JSON</a>
              <a href="/api/export/history.csv" class="btn" download>Export CSV</a>
            </div>
          </div>
          <table class="table" id="history-table">
            <thead>
              <tr>
                <th>ID</th>
                <th>Date/time</th>
                <th>Download (Mbps)</th>
                <th>Upload (Mbps)</th>
                <th>Ping (ms)</th>
                <th>Jitter (ms)</th>
                <th>Packet Loss (%)</th>
                <th>IP Address</th>
                <th>ISP</th>
                <th>Server</th>
              </tr>
            </thead>
            <tbody>
            </tbody>
          </table>
        </div>
      </section>

      <section id="view-preferences" class="view">
        <div class="panel">
          <div class="panel-header">
            <div class="panel-title">Appearance</div>
          </div>
          <div class="form">
            <div class="form-row form-row-inline">
              <div class="form-field">
                <label>Theme</label>
                <select id="pref-template">
                  {{range .TemplatesList}}<option value="{{.}}">{{.}}</option>{{end}}
                </select>
              </div>
              <div class="form-field">
                <label>Color Scheme</label>
                <select id="pref-scheme"></select>
              </div>
            </div>
          </div>
        </div>

        <div class="panel">
          <div class="panel-header">
            <div class="panel-title">Schedules</div>
          </div>
          <div id="schedules-list"></div>

          <form id="schedule-form" class="form">
            <input type="hidden" id="schedule-form-id" name="id" />
            <div class="form-row form-row-inline">
              <div class="form-field">
                <label>Name</label>
                <input type="text" id="schedule-form-name" name="name" />
              </div>
              <div class="form-field">
                <label>Type</label>
                <select id="schedule-form-type" name="type">
                  <option value="interval">Interval</option>
                  <option value="daily">Daily</option>
                </select>
              </div>
              <div class="form-field" id="schedule-form-every-field" style="display: none;">
                <label>Every</label>
                <input type="text" id="schedule-form-every" name="every" placeholder="1h, 30m, 6h" />
              </div>
              <div class="form-field" id="schedule-form-timeOfDay-field" style="display: none;">
                <label>Time of day</label>
                <input type="text" id="schedule-form-timeOfDay" name="timeOfDay" placeholder="14:30" />
              </div>
              <div class="form-field">
                <label>Enabled</label>
                <input type="checkbox" id="schedule-form-enabled" name="enabled" checked />
              </div>
              <div class="form-field">
                <label>&nbsp;</label>
                <button type="submit" class="btn" id="schedule-form-submit">Add</button>
              </div>
            </div>
            <button type="button" class="btn" id="schedule-form-cancel" style="display: none;">Cancel</button>
          </form>
        </div>
      </section>

      <section id="view-about" class="view">
        <div class="panel">
          <div class="about-section">
            <div class="about-logo"><i class="fas fa-tachometer-alt fa-3x"></i></div>
            <h3>speedplane</h3>
            <p class="about-version">Version {{.AppVersion}}</p>
            <p class="about-desc">A service with a web UI that runs speedtests on a schedule (or manually).</p>
            <div class="about-links">
              <a href="https://github.com/network-plane/speedplane" target="_blank" rel="noreferrer"><i class="fab fa-github"></i> Source Code</a>
            </div>
            <p class="about-copyright">© {{.Year}} network-plane</p>
          </div>
        </div>
      </section>
    </div>

  <script type="module" src="main.js"></script>
</body>
</html>
